<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>AST | yanxlg@blog</title><meta name="description" content="AST"><meta name="keywords" content="AST,Babel"><meta name="author" content="yanxlg"><meta name="copyright" content="yanxlg"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="https://yanxlg.github.io/7389a59f/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="AST"><meta name="twitter:description" content="AST"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="AST"><meta property="og:url" content="https://yanxlg.github.io/7389a59f/"><meta property="og:site_name" content="yanxlg@blog"><meta property="og:description" content="AST"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Babel" href="https://yanxlg.github.io/7056c18d/"><link rel="next" title="cacheStorage" href="https://yanxlg.github.io/f688fea9/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Bookmark',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  copyright: {"languages":{"author":"Author: yanxlg","link":"Link: https://yanxlg.github.io/7389a59f/","source":"Source: yanxlg@blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  copy_copyright_js: true
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">yanxlg@blog</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">50</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">21</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div></div><div id="body-wrap"><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">AST</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2019-11-02<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-02-27</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/h5/">h5</a></span><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>Reading time: 21 min</span><span class="post-meta__separator">|</span><span>Post View: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>提起 AST 抽象语法树，大家可能并不感冒，认为它和你的领域没有多少交集。但是提到它的使用场景，也许会让你大吃一惊。原来它一直在你左右与你相伴，而你却不知。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在计算机科学中，抽象语法树（abstract syntax tree 或者缩写为 AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码，例如less、sass、ES6、typescript、js等源代码。树上的每个节点都表示源代码中的一种结构。之所以说语法是「抽象」的，是因为这里的语法并不会表示出真实语法中出现的每个细节。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>前面说AST树一直伴随着我们左右，其实只要涉及到词法分析或语法分析的都会使用它，例如各种代码编辑、编译器，代码转换器（工具）等，而在前端中，我们接触到的功能主要有以下几种：</p>
<ul>
<li>JS反编译，语法分析</li>
<li>Babel编译ES6语法，Babel插件</li>
<li>代码高亮</li>
<li>关键字匹配</li>
<li>作用域判断</li>
<li>代码压缩</li>
<li>代码转换</li>
<li>代码补全</li>
<li>etc…</li>
</ul>
<h2 id="AST-Explorer"><a href="#AST-Explorer" class="headerlink" title="AST Explorer"></a>AST Explorer</h2><p>由于语法树一直以来比较抽象，没有一个比较好的方式去学习了解它，我们通常了解语法树的结构是通过<a href="https://astexplorer.net/" target="_blank" rel="noopener">AST Explorer</a>去查看相关的树结构。其中几乎支持所有前端语法，除部分预编译语言，如less、sass、stylus等。<br>通过该解释器，我们先观察一个简单的ES6代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> messages=[<span class="string">"I'm a student!"</span>];</span><br></pre></td></tr></table></figure>
<p>生成的JSON格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 32,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;VariableDeclaration&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 32,</span><br><span class="line">      &quot;declarations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;VariableDeclarator&quot;,</span><br><span class="line">          &quot;start&quot;: 4,</span><br><span class="line">          &quot;end&quot;: 31,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">            &quot;start&quot;: 4,</span><br><span class="line">            &quot;end&quot;: 12,</span><br><span class="line">            &quot;name&quot;: &quot;messages&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;init&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ArrayExpression&quot;,</span><br><span class="line">            &quot;start&quot;: 13,</span><br><span class="line">            &quot;end&quot;: 31,</span><br><span class="line">            &quot;elements&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">                &quot;start&quot;: 14,</span><br><span class="line">                &quot;end&quot;: 30,</span><br><span class="line">                &quot;value&quot;: &quot;I&apos;m a student!&quot;,</span><br><span class="line">                &quot;raw&quot;: &quot;\&quot;I&apos;m a student!\&quot;&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;kind&quot;: &quot;let&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而他的语法树如下：</p>
<img class="img-left lozad" title="ast1" data-src="/7389a59f/ex_1.png">
<p>我们发现AST语法树和DOM树很类似，都是树形结构，结构层次清清楚楚。</p>
<hr>

<p>再看一个<code>expression</code>的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>+<span class="number">2</span>)*<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>JSON格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 7,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;ExpressionStatement&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 7,</span><br><span class="line">      &quot;expression&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">        &quot;start&quot;: 0,</span><br><span class="line">        &quot;end&quot;: 7,</span><br><span class="line">        &quot;left&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">          &quot;start&quot;: 1,</span><br><span class="line">          &quot;end&quot;: 4,</span><br><span class="line">          &quot;left&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">            &quot;start&quot;: 1,</span><br><span class="line">            &quot;end&quot;: 2,</span><br><span class="line">            &quot;value&quot;: 1,</span><br><span class="line">            &quot;raw&quot;: &quot;1&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">          &quot;right&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">            &quot;start&quot;: 3,</span><br><span class="line">            &quot;end&quot;: 4,</span><br><span class="line">            &quot;value&quot;: 2,</span><br><span class="line">            &quot;raw&quot;: &quot;2&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;operator&quot;: &quot;*&quot;,</span><br><span class="line">        &quot;right&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">          &quot;start&quot;: 6,</span><br><span class="line">          &quot;end&quot;: 7,</span><br><span class="line">          &quot;value&quot;: 3,</span><br><span class="line">          &quot;raw&quot;: &quot;3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的AST树如下：</p>
<img class="img-left lozad" title="ast2" data-src="/7389a59f/ex_2.png">
<p>将表达式的<code>()</code>删除，我们做个对比：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 5,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;ExpressionStatement&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 5,</span><br><span class="line">      &quot;expression&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">        &quot;start&quot;: 0,</span><br><span class="line">        &quot;end&quot;: 5,</span><br><span class="line">        &quot;left&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">          &quot;start&quot;: 0,</span><br><span class="line">          &quot;end&quot;: 1,</span><br><span class="line">          &quot;value&quot;: 1,</span><br><span class="line">          &quot;raw&quot;: &quot;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">        &quot;right&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">          &quot;start&quot;: 2,</span><br><span class="line">          &quot;end&quot;: 5,</span><br><span class="line">          &quot;left&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">            &quot;start&quot;: 2,</span><br><span class="line">            &quot;end&quot;: 3,</span><br><span class="line">            &quot;value&quot;: 2,</span><br><span class="line">            &quot;raw&quot;: &quot;2&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;operator&quot;: &quot;*&quot;,</span><br><span class="line">          &quot;right&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Literal&quot;,</span><br><span class="line">            &quot;start&quot;: 4,</span><br><span class="line">            &quot;end&quot;: 5,</span><br><span class="line">            &quot;value&quot;: 3,</span><br><span class="line">            &quot;raw&quot;: &quot;3&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过对比发现，括号限制了表达式的优先级，在AST树中影响的是left和right中的结构顺序：</p>
<ol>
<li>在确定类型为<code>ExpressionStatement</code>后，它会按照代码执行的先后顺序，将表达式<code>BinaryExpression</code>分为<code>left</code>，<code>operator</code> 和 <code>right</code> 三块</li>
<li><code>left</code>：表示一个运算符的左侧，可以是另一个表达式也可以是一个具体的值</li>
<li><code>right</code>：表示一个运算符的右侧，可以是另一个表达式也可以是一个具体的值</li>
<li><code>left</code>和<code>right</code>都标明了类型，起止位置，值等信息；</li>
<li><code>operator</code>定义操作运算符；</li>
</ol>
<p>通过这样的结构我们可以自己实现复杂的<code>expression</code>的AST树，例如<code>(a*b+c)/d</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 9,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;ExpressionStatement&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 9,</span><br><span class="line">      &quot;expression&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">        &quot;start&quot;: 0,</span><br><span class="line">        &quot;end&quot;: 9,</span><br><span class="line">        &quot;left&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">          &quot;start&quot;: 1,</span><br><span class="line">          &quot;end&quot;: 6,</span><br><span class="line">          &quot;left&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">            &quot;start&quot;: 1,</span><br><span class="line">            &quot;end&quot;: 4,</span><br><span class="line">            &quot;left&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">              &quot;start&quot;: 1,</span><br><span class="line">              &quot;end&quot;: 2,</span><br><span class="line">              &quot;name&quot;: &quot;a&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;operator&quot;: &quot;*&quot;,</span><br><span class="line">            &quot;right&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">              &quot;start&quot;: 3,</span><br><span class="line">              &quot;end&quot;: 4,</span><br><span class="line">              &quot;name&quot;: &quot;b&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">          &quot;right&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">            &quot;start&quot;: 5,</span><br><span class="line">            &quot;end&quot;: 6,</span><br><span class="line">            &quot;name&quot;: &quot;c&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;operator&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;right&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">          &quot;start&quot;: 8,</span><br><span class="line">          &quot;end&quot;: 9,</span><br><span class="line">          &quot;name&quot;: &quot;d&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>

<p>再来看看我们常用的箭头函数的AST树：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test = <span class="function">(<span class="params">a,b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSON格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 39,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;VariableDeclaration&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 39,</span><br><span class="line">      &quot;declarations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;VariableDeclarator&quot;,</span><br><span class="line">          &quot;start&quot;: 6,</span><br><span class="line">          &quot;end&quot;: 39,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">            &quot;start&quot;: 6,</span><br><span class="line">            &quot;end&quot;: 10,</span><br><span class="line">            &quot;name&quot;: &quot;test&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;init&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ArrowFunctionExpression&quot;,</span><br><span class="line">            &quot;start&quot;: 13,</span><br><span class="line">            &quot;end&quot;: 39,</span><br><span class="line">            &quot;id&quot;: null,</span><br><span class="line">            &quot;expression&quot;: false,</span><br><span class="line">            &quot;generator&quot;: false,</span><br><span class="line">            &quot;async&quot;: false,</span><br><span class="line">            &quot;params&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 14,</span><br><span class="line">                &quot;end&quot;: 15,</span><br><span class="line">                &quot;name&quot;: &quot;a&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 16,</span><br><span class="line">                &quot;end&quot;: 17,</span><br><span class="line">                &quot;name&quot;: &quot;b&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;body&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;BlockStatement&quot;,</span><br><span class="line">              &quot;start&quot;: 22,</span><br><span class="line">              &quot;end&quot;: 39,</span><br><span class="line">              &quot;body&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;ReturnStatement&quot;,</span><br><span class="line">                  &quot;start&quot;: 26,</span><br><span class="line">                  &quot;end&quot;: 37,</span><br><span class="line">                  &quot;argument&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">                    &quot;start&quot;: 33,</span><br><span class="line">                    &quot;end&quot;: 36,</span><br><span class="line">                    &quot;left&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                      &quot;start&quot;: 33,</span><br><span class="line">                      &quot;end&quot;: 34,</span><br><span class="line">                      &quot;name&quot;: &quot;a&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">                    &quot;right&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                      &quot;start&quot;: 35,</span><br><span class="line">                      &quot;end&quot;: 36,</span><br><span class="line">                      &quot;name&quot;: &quot;b&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;kind&quot;: &quot;const&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的AST结构如下：</p>
<img class="lozad" title="ast3" data-src="/7389a59f/ex_3.png">
<p>我们会发现，其中相对于上面的简单例子，又增加了几个新的类型：</p>
<ul>
<li>ArrowFunctionExpression</li>
<li>BlockStatement</li>
<li>ReturnStatement<br>到这里，其实我们已经慢慢明白了：<br>抽象语法树其实就是将一类标签转化成通用标识符，从而结构出的一个类似于树形结构的语法树，只要了解其语法树的格式，类型定义就能深入的理解AST。</li>
</ul>
<h2 id="深入原理"><a href="#深入原理" class="headerlink" title="深入原理"></a>深入原理</h2><p>AST Explorer 可视化工具能够让我们快速认知AST，那么这些可视化工具、编译器、转换插件内部是怎么实现的呢，我们来看一个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAST</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>其JSON格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 19,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;FunctionDeclaration&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 19,</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">        &quot;start&quot;: 9,</span><br><span class="line">        &quot;end&quot;: 15,</span><br><span class="line">        &quot;name&quot;: &quot;getAST&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;expression&quot;: false,</span><br><span class="line">      &quot;generator&quot;: false,</span><br><span class="line">      &quot;async&quot;: false,</span><br><span class="line">      &quot;params&quot;: [],</span><br><span class="line">      &quot;body&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;BlockStatement&quot;,</span><br><span class="line">        &quot;start&quot;: 17,</span><br><span class="line">        &quot;end&quot;: 19,</span><br><span class="line">        &quot;body&quot;: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AST如下：</p>
<img class="lozad" title="ast4" data-src="/7389a59f/ex_4.png">
<p>我们通过第三方模块<code>esprima</code>、<code>estraverse</code>、<code>escodegen</code>三个包来实现树的遍历</p>
<ul>
<li><code>esprima</code> : 一个将js代码解析成AST树的包</li>
<li><code>estraverse</code>：遍历树的包</li>
<li><code>escodegen</code>：生成新的AST树的包<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> esprima = <span class="built_in">require</span>(<span class="string">'esprima'</span>); <span class="comment">//解析js的语法的包</span></span><br><span class="line"><span class="keyword">const</span> estraverse = <span class="built_in">require</span>(<span class="string">'estraverse'</span>); <span class="comment">//遍历树的包</span></span><br><span class="line"><span class="keyword">const</span> escodegen = <span class="built_in">require</span>(<span class="string">'escodegen'</span>); <span class="comment">//生成新的树的包</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`function getAST()&#123;&#125;`</span>;</span><br><span class="line"><span class="comment">//解析js的语法</span></span><br><span class="line"><span class="keyword">let</span> tree = esprima.parseScript(code);</span><br><span class="line"><span class="comment">//遍历树</span></span><br><span class="line">estraverse.traverse(tree, &#123;</span><br><span class="line">  enter(node) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'enter: '</span> + node.type);</span><br><span class="line">  &#125;,</span><br><span class="line">  leave(node) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'leave: '</span> + node.type);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//生成新的树</span></span><br><span class="line"><span class="keyword">let</span> r = escodegen.generate(tree);</span><br><span class="line"><span class="built_in">console</span>.log(r);</span><br></pre></td></tr></table></figure>
运行后输出结果为：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">enter: Program</span><br><span class="line">enter: FunctionDeclaration</span><br><span class="line">enter: Identifier</span><br><span class="line">leave: Identifier</span><br><span class="line">enter: BlockStatement</span><br><span class="line">leave: BlockStatement</span><br><span class="line">leave: FunctionDeclaration</span><br><span class="line">leave: Program</span><br><span class="line">function getAST() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
可以发现遍历过程使用的是深度优先算法，当然我们也可以自己实现对应的遍历算方法，不过遍历算法需要支持所有的类型，否则遍历会出现问题，除非你仅需要针对特定类型进行处理，例如<code>postcss</code>中的提供的遍历API。<br>通过遍历我们可以实现一定的代码转换功能，例如将上述函数名修改为<code>newAST</code>：<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> esprima = <span class="built_in">require</span>(<span class="string">'esprima'</span>); <span class="comment">//解析js的语法的包</span></span><br><span class="line"><span class="keyword">const</span> estraverse = <span class="built_in">require</span>(<span class="string">'estraverse'</span>); <span class="comment">//遍历树的包</span></span><br><span class="line"><span class="keyword">const</span> escodegen = <span class="built_in">require</span>(<span class="string">'escodegen'</span>); <span class="comment">//生成新的树的包</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`function getAST()&#123;&#125;`</span>;</span><br><span class="line"><span class="comment">//解析js的语法</span></span><br><span class="line"><span class="keyword">let</span> tree = esprima.parseScript(code);</span><br><span class="line"><span class="comment">//遍历树</span></span><br><span class="line">estraverse.traverse(tree, &#123;</span><br><span class="line">  enter(node) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'enter: '</span> + node.type);</span><br><span class="line">    <span class="keyword">if</span> (node.type === <span class="string">'Identifier'</span>) &#123;</span><br><span class="line">      node.name = <span class="string">'newAST'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//生成新的树</span></span><br><span class="line"><span class="keyword">let</span> r = escodegen.generate(tree);</span><br><span class="line"><span class="built_in">console</span>.log(r);</span><br></pre></td></tr></table></figure>
运行后结果为：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enter: Program</span><br><span class="line">enter: FunctionDeclaration</span><br><span class="line">enter: Identifier</span><br><span class="line">enter: BlockStatement</span><br><span class="line">function newAST() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
可以看到，在我们的干预下，输出的结果发生了变化，方法名编译后方法名变成了newAST。<br>这就是抽象语法树的强大之处，本质上通过编译，我们可以去改变任何输出结果。<br>这也是大部分开发工具编译的核心，包括babel、less、sass、postcss前端常用转换工具等。</li>
</ul>
<hr>

<p>AST Node类型大致有以下集合：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> INodeType= <span class="string">"Identifier"</span> | <span class="string">"SimpleLiteral"</span> | <span class="string">"RegExpLiteral"</span> |</span><br><span class="line"> <span class="string">"Program"</span> | <span class="string">"FunctionDeclaration"</span> | <span class="string">"FunctionExpression"</span> |</span><br><span class="line"> <span class="string">"ArrowFunctionExpression"</span> | <span class="string">"SwitchCase"</span> | <span class="string">"CatchClause"</span> |</span><br><span class="line"> <span class="string">"VariableDeclarator"</span> | <span class="string">"ExpressionStatement"</span> | <span class="string">"BlockStatement"</span> |</span><br><span class="line"> <span class="string">"EmptyStatement"</span> | <span class="string">"DebuggerStatement"</span> | <span class="string">"WithStatement"</span> |</span><br><span class="line"> <span class="string">"ReturnStatement"</span> | <span class="string">"LabeledStatement"</span> | <span class="string">"BreakStatement"</span> |</span><br><span class="line"> <span class="string">"ContinueStatement"</span> | <span class="string">"IfStatement"</span> | <span class="string">"SwitchStatement"</span> |</span><br><span class="line"> <span class="string">"ThrowStatement"</span> | <span class="string">"TryStatement"</span> | <span class="string">"WhileStatement"</span> |</span><br><span class="line"> <span class="string">"DoWhileStatement"</span> | <span class="string">"ForStatement"</span> | <span class="string">"ForInStatement"</span> |</span><br><span class="line"> <span class="string">"ForOfStatement"</span> | <span class="string">"VariableDeclaration"</span> | <span class="string">"ClassDeclaration"</span> |</span><br><span class="line"> <span class="string">"ThisExpression"</span> | <span class="string">"ArrayExpression"</span> | <span class="string">"ObjectExpression"</span> |</span><br><span class="line"> <span class="string">"YieldExpression"</span> | <span class="string">"UnaryExpression"</span> | <span class="string">"UpdateExpression"</span> |</span><br><span class="line"> <span class="string">"BinaryExpression"</span> | <span class="string">"AssignmentExpression"</span> | <span class="string">"LogicalExpression"</span> |</span><br><span class="line"> <span class="string">"MemberExpression"</span> | <span class="string">"ConditionalExpression"</span> |</span><br><span class="line"> <span class="string">"SimpleCallExpression"</span> | <span class="string">"NewExpression"</span> | <span class="string">"SequenceExpression"</span> |</span><br><span class="line"> <span class="string">"TemplateLiteral"</span> | <span class="string">"TaggedTemplateExpression"</span> | <span class="string">"ClassExpression"</span> |</span><br><span class="line"> <span class="string">"MetaProperty"</span> | <span class="string">"AwaitExpression"</span> | <span class="string">"Property"</span> |</span><br><span class="line"> <span class="string">"AssignmentProperty"</span> | <span class="string">"Super"</span> | <span class="string">"TemplateElement"</span> | <span class="string">"SpreadElement"</span> |</span><br><span class="line"> <span class="string">"ObjectPattern"</span> | <span class="string">"ArrayPattern"</span> | <span class="string">"RestElement"</span> | <span class="string">"AssignmentPattern"</span> |</span><br><span class="line"> <span class="string">"ClassBody"</span> | <span class="string">"MethodDefinition"</span> | <span class="string">"ImportDeclaration"</span> | </span><br><span class="line"> <span class="string">"ExportNamedDeclaration"</span> | <span class="string">"ExportDefaultDeclaration"</span> |</span><br><span class="line"> <span class="string">"ExportAllDeclaration"</span> | <span class="string">"ImportSpecifier"</span> | <span class="string">"ImportDefaultSpecifier"</span> |</span><br><span class="line"> <span class="string">"ImportNamespaceSpecifier"</span> | <span class="string">"ExportSpecifier"</span> | <span class="string">"Directive"</span> | <span class="string">"DirectiveLiteral"</span> |</span><br><span class="line"> <span class="string">"CallExpression"</span> | <span class="string">"File"</span> | <span class="string">"StringLiteral"</span> | <span class="string">"NumericLiteral"</span> | <span class="string">"NullLiteral"</span> |</span><br><span class="line"> <span class="string">"BooleanLiteral"</span> | <span class="string">"ObjectMethod"</span> | <span class="string">"ObjectProperty"</span> | <span class="string">"ExportNamedDeclaration"</span> |</span><br><span class="line"> <span class="string">"ClassMethod"</span> | <span class="string">"AnyTypeAnnotation"</span> | <span class="string">"ArrayTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"BooleanTypeAnnotation"</span> | <span class="string">"BooleanLiteralTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"NullLiteralTypeAnnotation"</span> | <span class="string">"ClassImplements"</span> | <span class="string">"ClassProperty"</span> | <span class="string">"DeclareClass"</span> |</span><br><span class="line"> <span class="string">"DeclareFunction"</span> | <span class="string">"DeclareInterface"</span> | <span class="string">"DeclareModule"</span> | <span class="string">"DeclareTypeAlias"</span> |</span><br><span class="line"> <span class="string">"DeclareVariable"</span> | <span class="string">"ExistentialTypeParam"</span> | <span class="string">"FunctionTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"FunctionTypeParam"</span> | <span class="string">"GenericTypeAnnotation"</span> | <span class="string">"InterfaceExtends"</span> | <span class="string">"InterfaceDeclaration"</span> |</span><br><span class="line"> <span class="string">"IntersectionTypeAnnotation"</span> | <span class="string">"MixedTypeAnnotation"</span> | <span class="string">"NullableTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"NumericLiteralTypeAnnotation"</span> | <span class="string">"NumberTypeAnnotation"</span> | <span class="string">"StringLiteralTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"StringTypeAnnotation"</span> | <span class="string">"ThisTypeAnnotation"</span> | <span class="string">"TupleTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"TypeofTypeAnnotation"</span> | <span class="string">"TypeAlias"</span> | <span class="string">"TypeAnnotation"</span> | <span class="string">"TypeCastExpression"</span> |</span><br><span class="line"> <span class="string">"TypeParameterDeclaration"</span> | <span class="string">"TypeParameterInstantiation"</span> | <span class="string">"ObjectTypeAnnotation"</span> |</span><br><span class="line"> <span class="string">"ObjectTypeCallProperty"</span> | <span class="string">"ObjectTypeIndexer"</span> | <span class="string">"ObjectTypeProperty"</span> |</span><br><span class="line"> <span class="string">"QualifiedTypeIdentifier"</span> | <span class="string">"UnionTypeAnnotation"</span> | <span class="string">"VoidTypeAnnotation"</span> | <span class="string">"JSXAttribute"</span> |</span><br><span class="line"> <span class="string">"JSXClosingElement"</span> | <span class="string">"JSXElement"</span> | <span class="string">"JSXEmptyExpression"</span> | <span class="string">"JSXExpressionContainer"</span> |</span><br><span class="line"> <span class="string">"JSXIdentifier"</span> | <span class="string">"JSXMemberExpression"</span> | <span class="string">"JSXNamespacedName"</span> | <span class="string">"JSXOpeningElement"</span> |</span><br><span class="line"> <span class="string">"JSXSpreadAttribute"</span> | <span class="string">"JSXText"</span> | <span class="string">"Noop"</span> | <span class="string">"ParenthesizedExpression"</span> | <span class="string">"AwaitExpression"</span> |</span><br><span class="line"> <span class="string">"BindExpression"</span> | <span class="string">"Decorator"</span> | <span class="string">"DoExpression"</span> | <span class="string">"ExportDefaultSpecifier"</span> |</span><br><span class="line"> <span class="string">"ExportNamespaceSpecifier"</span> | <span class="string">"RestProperty"</span> | <span class="string">"SpreadProperty"</span> | <span class="string">"TSAnyKeyword"</span> |</span><br><span class="line"> <span class="string">"TSArrayType"</span> | <span class="string">"TSAsExpression"</span> | <span class="string">"TSBooleanKeyword"</span> | <span class="string">"TSCallSignatureDeclaration"</span> |</span><br><span class="line"> <span class="string">"TSConstructSignatureDeclaration"</span> | <span class="string">"TSConstructorType"</span> | <span class="string">"TSDeclareFunction"</span> |</span><br><span class="line"> <span class="string">"TSDeclareMethod"</span> | <span class="string">"TSEnumDeclaration"</span> | <span class="string">"TSEnumMember"</span> | <span class="string">"TSExportAssignment"</span> |</span><br><span class="line"> <span class="string">"TSExpressionWithTypeArguments"</span> | <span class="string">"TSExternalModuleReference"</span> | <span class="string">"TSFunctionType"</span> |</span><br><span class="line"> <span class="string">"TSImportEqualsDeclaration"</span> | <span class="string">"TSIndexSignature"</span> | <span class="string">"TSIndexedAccessType"</span> | <span class="string">"TSInterfaceBody"</span> |</span><br><span class="line"> <span class="string">"TSInterfaceDeclaration"</span> | <span class="string">"TSIntersectionType"</span> | <span class="string">"TSLiteralType"</span> | <span class="string">"TSMappedType"</span> |</span><br><span class="line"> <span class="string">"TSMethodSignature"</span> | <span class="string">"TSModuleBlock"</span> | <span class="string">"TSModuleDeclaration"</span> | <span class="string">"TSNamespaceExportDeclaration"</span> |</span><br><span class="line"> <span class="string">"TSNeverKeyword"</span> | <span class="string">"TSNonNullExpression"</span> | <span class="string">"TSNullKeyword"</span> | <span class="string">"TSNumberKeyword"</span> |</span><br><span class="line"> <span class="string">"TSObjectKeyword"</span> | <span class="string">"TSParameterProperty"</span> | <span class="string">"TSParenthesizedType"</span> | <span class="string">"TSPropertySignature"</span> |</span><br><span class="line"> <span class="string">"TSQualifiedName"</span> | <span class="string">"TSStringKeyword"</span> | <span class="string">"TSSymbolKeyword"</span> | <span class="string">"TSThisType"</span> | <span class="string">"TSTupleType"</span> |</span><br><span class="line"> <span class="string">"TSTypeAliasDeclaration"</span> | <span class="string">"TSTypeAnnotation"</span> | <span class="string">"TSTypeAssertion"</span> | <span class="string">"TSTypeLiteral"</span> |</span><br><span class="line"> <span class="string">"TSTypeOperator"</span> | <span class="string">"TSTypeParameter"</span> | <span class="string">"TSTypeParameterDeclaration"</span> |</span><br><span class="line"> <span class="string">"TSTypeParameterInstantiation"</span> | <span class="string">"TSTypePredicate"</span> | <span class="string">"TSTypeQuery"</span> | <span class="string">"TSTypeReference"</span> |</span><br><span class="line"> <span class="string">"TSUndefinedKeyword"</span> | <span class="string">"TSUnionType"</span> | <span class="string">"TSVoidKeyword"</span>;</span><br></pre></td></tr></table></figure>
<p>其中包括JSX、typescript 的AST类型，基本上根据类型名称都能了解其表示的含义，AST树就是由这些类型及其特定的属性组成的一个层级结构。<br>介绍到这边，你应该联想到 <code>Babel</code>，联想到 <code>js 混淆</code>，联想到更多背后的东西。接下来，我们要介绍介绍 <code>Babel</code> 是如何将 <code>ES6</code> 转成 <code>ES5</code> 的。</p>
<h2 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h2><p>Babel本质上是一个编译器，他是将很多超前的，未在W3C规范中的语法编译转换成复合W3C规范的，旧代码执行器支持的代码。其具体内容本文不作介绍，如需了解请查看<a href="/7056c18d/" title="Babel">Babel</a>。<br>由于Es6、ES7、ES8、ES9等兼容性问题，在旧版本的代码执行器（浏览器环境）下，无法正确识别并执行，因此我们前端开发通常在build时使用babel将其转换成ES5的代码，确保低版本兼容性。下面我们来看看Babel是如何工作的。<br>箭头函数转成function：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sum = <span class="function">(<span class="params">a, b</span>)=&gt;</span>&#123;<span class="keyword">return</span> a+b&#125;;</span><br></pre></td></tr></table></figure>
<p>JSON格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 31,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;VariableDeclaration&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 31,</span><br><span class="line">      &quot;declarations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;VariableDeclarator&quot;,</span><br><span class="line">          &quot;start&quot;: 4,</span><br><span class="line">          &quot;end&quot;: 30,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">            &quot;start&quot;: 4,</span><br><span class="line">            &quot;end&quot;: 7,</span><br><span class="line">            &quot;name&quot;: &quot;sum&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;init&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ArrowFunctionExpression&quot;,</span><br><span class="line">            &quot;start&quot;: 10,</span><br><span class="line">            &quot;end&quot;: 30,</span><br><span class="line">            &quot;id&quot;: null,</span><br><span class="line">            &quot;expression&quot;: false,</span><br><span class="line">            &quot;generator&quot;: false,</span><br><span class="line">            &quot;async&quot;: false,</span><br><span class="line">            &quot;params&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 11,</span><br><span class="line">                &quot;end&quot;: 12,</span><br><span class="line">                &quot;name&quot;: &quot;a&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 14,</span><br><span class="line">                &quot;end&quot;: 15,</span><br><span class="line">                &quot;name&quot;: &quot;b&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;body&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;BlockStatement&quot;,</span><br><span class="line">              &quot;start&quot;: 18,</span><br><span class="line">              &quot;end&quot;: 30,</span><br><span class="line">              &quot;body&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                  &quot;type&quot;: &quot;ReturnStatement&quot;,</span><br><span class="line">                  &quot;start&quot;: 19,</span><br><span class="line">                  &quot;end&quot;: 29,</span><br><span class="line">                  &quot;argument&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">                    &quot;start&quot;: 26,</span><br><span class="line">                    &quot;end&quot;: 29,</span><br><span class="line">                    &quot;left&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                      &quot;start&quot;: 26,</span><br><span class="line">                      &quot;end&quot;: 27,</span><br><span class="line">                      &quot;name&quot;: &quot;a&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">                    &quot;right&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                      &quot;start&quot;: 28,</span><br><span class="line">                      &quot;end&quot;: 29,</span><br><span class="line">                      &quot;name&quot;: &quot;b&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;kind&quot;: &quot;let&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们通过Babel模拟转换过程如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'babel-core'</span>); <span class="comment">//babel核心解析库</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>); <span class="comment">//babel类型转化库</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`let sum = (a, b)=&gt;&#123;return a+b&#125;`</span>;</span><br><span class="line"><span class="keyword">let</span> ArrowPlugins = &#123;</span><br><span class="line"><span class="comment">//访问者模式</span></span><br><span class="line">visitor: &#123;</span><br><span class="line">  <span class="comment">//捕获匹配的API</span></span><br><span class="line">    ArrowFunctionExpression(path) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; node &#125; = path;</span><br><span class="line">      <span class="keyword">let</span> body = node.body;</span><br><span class="line">      <span class="keyword">let</span> params = node.params;</span><br><span class="line">      <span class="keyword">let</span> r = t.functionExpression(<span class="literal">null</span>, params, body, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      path.replaceWith(r);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> d = babel.transform(code, &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    ArrowPlugins</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(d.code);</span><br></pre></td></tr></table></figure>
<p><code>babel-core</code>是Babel的核心库，<code>babel-types</code>是Babel的类型转换库，通常我们开发Babel插件时需要了解这两个库，此处不作详细介绍，通过运行上述代码，我们得到的结果是：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sum = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里，我们完美的将箭头函数转换成了标准函数。<code>但是这也仅仅是针对这一一种情况而言，箭头函数还支持简写，如果是简写那么，该插件就会报错，因为其body中的结构和之前不一样了，此时JSON格式如下：</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;Program&quot;,</span><br><span class="line">  &quot;start&quot;: 0,</span><br><span class="line">  &quot;end&quot;: 21,</span><br><span class="line">  &quot;body&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;type&quot;: &quot;VariableDeclaration&quot;,</span><br><span class="line">      &quot;start&quot;: 0,</span><br><span class="line">      &quot;end&quot;: 21,</span><br><span class="line">      &quot;declarations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;VariableDeclarator&quot;,</span><br><span class="line">          &quot;start&quot;: 4,</span><br><span class="line">          &quot;end&quot;: 21,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">            &quot;start&quot;: 4,</span><br><span class="line">            &quot;end&quot;: 7,</span><br><span class="line">            &quot;name&quot;: &quot;sum&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;init&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;ArrowFunctionExpression&quot;,</span><br><span class="line">            &quot;start&quot;: 10,</span><br><span class="line">            &quot;end&quot;: 21,</span><br><span class="line">            &quot;id&quot;: null,</span><br><span class="line">            &quot;expression&quot;: true,</span><br><span class="line">            &quot;generator&quot;: false,</span><br><span class="line">            &quot;async&quot;: false,</span><br><span class="line">            &quot;params&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 11,</span><br><span class="line">                &quot;end&quot;: 12,</span><br><span class="line">                &quot;name&quot;: &quot;a&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 14,</span><br><span class="line">                &quot;end&quot;: 15,</span><br><span class="line">                &quot;name&quot;: &quot;b&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;body&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;BinaryExpression&quot;,</span><br><span class="line">              &quot;start&quot;: 18,</span><br><span class="line">              &quot;end&quot;: 21,</span><br><span class="line">              &quot;left&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 18,</span><br><span class="line">                &quot;end&quot;: 19,</span><br><span class="line">                &quot;name&quot;: &quot;a&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;operator&quot;: &quot;+&quot;,</span><br><span class="line">              &quot;right&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;Identifier&quot;,</span><br><span class="line">                &quot;start&quot;: 20,</span><br><span class="line">                &quot;end&quot;: 21,</span><br><span class="line">                &quot;name&quot;: &quot;b&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;kind&quot;: &quot;let&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;sourceType&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，body 类型变成 BinaryExpression 不再是 BlockStatement，所以需要做一些兼容修改：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">'babel-core'</span>); <span class="comment">//babel核心解析库</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>); <span class="comment">//babel类型转化库</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`let sum = (a, b)=&gt; a+b`</span>;</span><br><span class="line"><span class="keyword">let</span> ArrowPlugins = &#123;</span><br><span class="line"><span class="comment">//访问者模式</span></span><br><span class="line">  visitor: &#123;</span><br><span class="line">  <span class="comment">//捕获匹配的API</span></span><br><span class="line">    ArrowFunctionExpression(path) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123; node &#125; = path;</span><br><span class="line">      <span class="keyword">let</span> params = node.params;</span><br><span class="line">      <span class="keyword">let</span> body = node.body;</span><br><span class="line">      <span class="keyword">if</span>(!t.isBlockStatement(body))&#123;</span><br><span class="line">        <span class="keyword">let</span> returnStatement = t.returnStatement(body);</span><br><span class="line">        body = t.blockStatement([returnStatement]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> r = t.functionExpression(<span class="literal">null</span>, params, body, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">      path.replaceWith(r);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> d = babel.transform(code, &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    ArrowPlugins</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(d.code);</span><br></pre></td></tr></table></figure>
<p>最终输出结果：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sum = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>到这边，看起来这个插件已经完美了，但是真实的<a href="https://babeljs.io/docs/en/babel-plugin-transform-arrow-functions" target="_blank" rel="noopener">babel-plugin-transform-arrow-function</a>并不是这么简单，它内部还涉及到this指向的问题，此处不作详细讲解。</p>
<hr>

<p>上文我们简单演示了 Babel 是如何来编译代码的，但是并非简单如此。<br>Babel 使用一个基于 ESTree 并修改过的 AST，其使用的是开源的<a href="https://github.com/babel/babylon" target="_blank" rel="noopener">babylon</a>解析库，目前改名为<a href="https://github.com/babel/babel/tree/master/packages/babel-parser" target="_blank" rel="noopener">babel-parser</a>。<br>正如我们上面示例代码一样，Babel 的三个主要处理步骤分别是： 解析（parse），转换（transform），生成（generate）。</p>
<ol>
<li><p>解析（parse）：解析步骤接收代码并输出处理后的 AST。 这个步骤分为两个阶段：词法分析 Lexical Analysis 和语法分析Syntactic Analysis。</p>
<ul>
<li>词法分析：词法分析阶段把字符串形式的代码转换为令牌（tokens） 流。你可以把令牌看作是一个扁平的语法片段数组：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n * n;</span><br></pre></td></tr></table></figure>
例如上面的代码片段，解析结果如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123; <span class="attr">type</span>: &#123; ... &#125;, <span class="attr">value</span>: <span class="string">"n"</span>, <span class="attr">start</span>: <span class="number">0</span>, <span class="attr">end</span>: <span class="number">1</span>, <span class="attr">loc</span>: &#123; ... &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: &#123; ... &#125;, <span class="attr">value</span>: <span class="string">"*"</span>, <span class="attr">start</span>: <span class="number">2</span>, <span class="attr">end</span>: <span class="number">3</span>, <span class="attr">loc</span>: &#123; ... &#125; &#125;,</span><br><span class="line">  &#123; <span class="attr">type</span>: &#123; ... &#125;, <span class="attr">value</span>: <span class="string">"n"</span>, <span class="attr">start</span>: <span class="number">4</span>, <span class="attr">end</span>: <span class="number">5</span>, <span class="attr">loc</span>: &#123; ... &#125; &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
每一个 type 有一组属性来描述该令牌，和 AST 节点一样它们也有 start，end，loc 属性：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: &#123;</span><br><span class="line">    label: &apos;name&apos;,</span><br><span class="line">    keyword: undefined,</span><br><span class="line">    beforeExpr: false,</span><br><span class="line">    startsExpr: true,</span><br><span class="line">    rightAssociative: false,</span><br><span class="line">    isLoop: false,</span><br><span class="line">    isAssign: false,</span><br><span class="line">    prefix: false,</span><br><span class="line">    postfix: false,</span><br><span class="line">    binop: null,</span><br><span class="line">    updateContext: null</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>语法分析：语法分析阶段会把一个令牌流转换成 AST 的形式。 这个阶段会使用令牌中的信息把它们转换成一个 AST 的表述结构，这样更易于后续的操作。</li>
</ul>
</li>
<li><p>转换（transform）：接收 AST 并对其进行遍历，在此过程中对节点进行添加、更新及移除等操作。 这是 Babel 或是其他编译器中最复杂的过程，同时也是插件将要介入工作的部分。</p>
</li>
<li><p>生成（generate）：代码生成步骤把最终（经过一系列转换之后）的 AST 转换成字符串形式的代码，同时还会创建源码映射（source maps）。代码生成其实很简单：深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</p>
</li>
</ol>
<p>了解这这些过程，其实会发现我们上面实现的箭头函数转换插件变得很简单。</p>
<h2 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h2><p>AST的处理和转换需要使用到树形的遍历，树形遍历算法通常有前序、中序、后序、广度优先、深度优先，关于树遍历的算法本文不作详解，有兴趣的可以查阅资料或者转到<a href="/e06277db/" title="Tree Structure">Tree Structure</a>中了解。<br>我们发现上述使用了很多关于树操作的API，这些API并不是AST本身自带的API，而是每个parser赋予它的，AST本质上是一个树形数据结构，也可以看做是一个JSON，具体的每个parser的API我们后面介绍相关插件开发的时候再做补充说明。</p>
<h2 id="扩展（具体语法树）"><a href="#扩展（具体语法树）" class="headerlink" title="扩展（具体语法树）"></a>扩展（具体语法树）</h2><p>AST被称为抽象语法树，看到这个名词的时候我们很可能会想，那对应的具体语法树呢？<br>对的，具体语法树是存在的，具体语法树通常被称作分析树。一般的，在源代码的翻译和编译过程中，语法分析器创建出分析树。一旦AST 被创建出来，在后续的处理过程中，比如语义分析阶段，会添加一些信息。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">yanxlg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://yanxlg.github.io/7389a59f/">https://yanxlg.github.io/7389a59f/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AST/">AST    </a><a class="post-meta__tags" href="/tags/Babel/">Babel    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/7056c18d/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>Babel</span></div></a></div><div class="next-post pull-right"><a href="/f688fea9/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>cacheStorage</span></div></a></div></nav></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By yanxlg</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" target="_blank" rel="noopener" title="Traditional Chinese and Simplified Chinese Conversion">繁</a><i class="nightshift fa fa-moon-o" id="nightshift" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/performance.js"></script><script src="/js/nightshift.js"></script><script color="0,0,255" opacity="0.7" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/js/canvas-nest.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>